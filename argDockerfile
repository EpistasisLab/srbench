FROM srbench-base as base

# Install env
################################################################################
ARG ALGORITHM
# this is needed because RUN commands don't expand ARG definitions
# ENV Algorithm ${ALGORITHM}
#USER $MAMBA_USER
SHELL ["/bin/bash", "-c"]
WORKDIR "/install"
COPY base_environment.yml install_algorithm.sh . 
# COPY experiment experiment/
# RUN mkdir algorithms
COPY ./algorithms/${ALGORITHM} ./${ALGORITHM}
RUN ls -l
RUN echo $ALGORITHM
RUN bash install_algorithm.sh $ALGORITHM

VOLUME ["/srbench"]
WORKDIR "/srbench"
# COPY scripts/copy_algorithm_files.sh ./
# RUN bash copy_algorithm_files.sh /install/$ALGORITHM experiment/methods
#SHELL ["/entry.sh", "/bin/bash", "-c"]
ENV CONDA_DEFAULT_ENV srbench-$ALGORITHM
ENV CONDA_TARGET_ENV=srbench-$ALGORITHM
RUN mamba init bash && echo 'conda activate "${CONDA_TARGET_ENV:-base}"' >>  ~/.bashrc
ENV ALGO=$ALGORITHM
# RUN echo 'bash link_algorithm_files.sh /install/$ALGO /srbench/methods' >> ~/.bashrc
# Make RUN commands use the new environment:
#ENTRYPOINT ["/bin/bash", "-c", "mamba", "run", "-n", ${ALGORITHM}, "/bin/sh", "-c"]
ENTRYPOINT ["/bin/bash", "-c"]
#ENTRYPOINT mamba run -n $ALGORITHM /bin/sh -c
# copy algorithm files
#COPY scripts/link_algorithm_files.sh ./
WORKDIR "/"
COPY entry.sh /
RUN chmod +x /entry.sh
ENTRYPOINT ["/entry.sh", "/bin/bash", "-c"]
WORKDIR "/srbench"
